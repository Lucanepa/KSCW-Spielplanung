<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Team Matches Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; padding: 20px; }
    table.calendar { width: 100%; table-layout: fixed; margin-bottom: 40px; }
    .calendar th, .calendar td {
      border: 1px solid #ddd;
      padding: 5px;
      vertical-align: top;
      height: 100px;
      font-size: 12px;
      position: relative;
    }
    .calendar th { background: #007bff; color: white; }
    .match {
      display: block;
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 11px;
      color: black;
    }
    .closure {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      opacity: 0.8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
    }
  </style>
</head>
<body>
  <h4>ðŸ“… Team Matches Planning</h4>
  <button class="btn btn-primary mb-3" onclick="loadData()">ðŸ”„ Refresh</button>
  <div id="calendar-container"></div>

  <script>
    const teamColor = {};

    function getRandomColor() {
      return '#' + Math.floor(Math.random()*16777215).toString(16);
    }

    function loadData() {
      const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbxGnj5qSC9jB0zXC5wF43X1XeOio97btH0W382vwO5JQQz9nsYyYZl7Ejh5Z0pTgBaOZQ/exec';

      fetch(appsScriptUrl)
        .then(res => res.json())
        .then(({matches, closures}) => renderCalendar(matches, closures))
        .catch(e => console.error('Error:', e));
    }

    function renderCalendar(matches, closures) {
      const container = document.getElementById('calendar-container');
      container.innerHTML = '';

      const byMatch = {};
      matches.forEach(e => {
        byMatch[e.date] = byMatch[e.date] || [];
        byMatch[e.date].push(e);
        if (!teamColor[e.team]) {
          teamColor[e.team] = getRandomColor();
        }
      });
      Object.keys(byMatch).forEach(date => byMatch[date].sort((a,b) => a.time.localeCompare(b.time)));

      const byClose = {};
      closures.forEach(c => byClose[c.date] = c.reason.toLowerCase());

      const months = [];
      let cur = new Date(2025,8,1);
      const end = new Date(2026,3,1);
      while (cur <= end) {
        months.push(`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}`);
        cur.setMonth(cur.getMonth()+1);
      }

      const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

      months.forEach(month => {
        const [y, MM] = month.split('-').map(Number);
        const first = new Date(y, MM-1, 1);
        const last = new Date(y, MM, 0);

        let html = `<table class="calendar"><thead>` +
                   `<tr><th colspan="7">${first.toLocaleString('en-GB',{month:'long',year:'numeric'})}</th></tr>` +
                   `<tr>${weekdays.map(d=>`<th>${d}</th>`).join('')}</tr>` +
                   `</thead><tbody><tr>`;

        const startIdx = (first.getDay()+6)%7;
        for(let i=0;i<startIdx;i++)html+='<td></td>';

        for(let d=1; d<=last.getDate(); d++) {
          const ds=`${y}-${String(MM).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const evs=byMatch[ds]||[];
          const reason=byClose[ds];

          let cell=`<td><strong>${d}</strong>`;
          evs.forEach(e=>cell+=`<div class="match" style="background:${teamColor[e.team]}">${e.time} â€“ ${e.team} (${e.type})</div>`);
          if(reason){
            const clr=reason==='holiday'?'#6c757d':'#000';
            cell+=`<div class="closure" style="background:${clr}">${reason.charAt(0).toUpperCase()+reason.slice(1)}</div>`;
          }
          cell+='</td>';

          html+=cell;
          if((startIdx+d-1)%7===6)html+='</tr><tr>';
        }
        html+='</tr></tbody></table>';
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
